<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>予約完了</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="./style.css" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="card">
    <h2>予約完了</h2>
    <div id="body"></div>
    <p>変更などあれば、LINEからでも修正できます。　　または、受取店舗までご連絡をお願いします。</p>
    <button id="closeBtn">閉じる</button>
  </div>

<script>
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxHhQPDw-NUrpfmovenkrtLkji4_NMXuO875S-_7BbmRfOua8_BgyXR5wdDWppcL9R5SA/exec";
const LIFF_ID = "2008688976-XABikxct";

document.addEventListener("DOMContentLoaded", async () => {
  await liff.init({ liffId: LIFF_ID });

  const params = new URLSearchParams(location.search);
  const rn = params.get("rn") || "";
  const name = params.get("name") || "";
  const phone = params.get("phone") || "";
  const store = params.get("store") || "";
  const pickup = params.get("pickup") || "";
  const total = params.get("total") || "";

  const html = `
    <p>予約番号: ${rn}</p>
    <p>お名前: ${name} 様</p>
    <p>電話番号: ${phone}</p>
    <p>店舗: ${store}</p>
    <p>受取時間: ${pickup}</p>
    <p>合計(税込): ¥${total}</p>
  `;
  document.getElementById("body").innerHTML = html;

  // LINE通知（ユーザーにプッシュ）※ユーザーID取得
try {
  const profile = await liff.getProfile();
  const userId = profile.userId;
  const messageText = `ご予約ありがとうございます。\n予約番号: ${rn}\n店舗: ${store}\n受取時間: ${pickup}\n合計(税込): ¥${total}`;
  await fetch(GAS_WEBAPP_URL, {
    method: "POST", headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ action: "pushLineMessage", userId, messageText })
  }).then(r=>r.json());
} catch (e) {
  console.log("LINE push skipped:", e);
}

  document.getElementById("closeBtn").addEventListener("click", () => {
    if (liff.isInClient()) liff.closeWindow();
    else location.href = "./index.html";
  });
});
</script>
</body>
</html>