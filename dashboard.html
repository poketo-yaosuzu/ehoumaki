<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<title>予約ダッシュボード</title>
<style>
body {
  font-family: "Noto Sans JP", sans-serif;
  background: #f1f3f4;
  padding: 16px;
  margin: 0;
}

h2, h3 {
  margin: 0 0 12px;
  color: #333;
  font-weight: 700;
}

#store-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.store-btn {
  padding: 8px 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  font-size: 14px;
}

.store-btn.active {
  background: #06c755;
  color: #fff;
  border-color: #06c755;
}

.card {
  background: #fff;
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.label {
  color: #777;
  font-size: 12px;
  margin-bottom: 2px;
}

.value {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}

.time-block {
  background: #fff;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 10px;
  border-left: 6px solid #06c755;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.time-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 6px;
  color: #06c755;
}
</style>
</head>
<body>

<h2>恵方巻予約一覧</h2>
<div id="store-buttons">
  <button class="store-btn active" onclick="filterStore('all', this)">全体</button>
  <button class="store-btn" onclick="filterStore('ポケット店', this)">ポケット店</button>
  <button class="store-btn" onclick="filterStore('アップティ店', this)">アップティ店</button>
  <button class="store-btn" onclick="filterStore('キララ店', this)">キララ店</button>
  <button class="store-btn" onclick="filterStore('総菜工場', this)">総菜工場</button>
</div>
<div id="list">読み込み中…</div>
  <h3>商品ごとの必要数</h3>
<div id="summary"></div>
<h3>時間帯ごとの必要数</h3>
<div id="time-summary"></div>
<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycby7WWViNlCVrzsl0ALI4rB-hZncgtgyFmbNW8IB66mZusBlJ4ntppprcCd9-HdHGEfcKw/exec";
  
  let dashboardData = [];

async function loadDashboard() {
  // モーダル表示
  Swal.fire({
    title: "読み込み中…",
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  const res = await fetch(`${GAS_URL}?mode=dashboard`);
  const json = await res.json();

  // モーダル閉じる
  Swal.close();

  dashboardData = json.list;
  renderList(dashboardData);

  const summary = calcSummary(dashboardData);
  renderSummary(summary);

  const timeSummary = calcTimeSummary(dashboardData);
  renderTimeSummary(timeSummary);
}  
  
function renderList(data) {
  const list = document.getElementById("list");
  list.innerHTML = "";

  const table = document.createElement("table");
  table.style.width = "100%";
  table.style.borderCollapse = "collapse";
  table.style.background = "#fff";
  table.style.borderRadius = "8px";
  table.style.overflow = "hidden";
  table.style.boxShadow = "0 4px 12px rgba(0,0,0,0.06)";
  table.style.fontSize = "14px";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr style="background:#06c755; color:#fff;">
      <th style="padding:8px;">予約番号</th>
      <th style="padding:8px;">名前</th>
      <th style="padding:8px;">電話番号</th>
      <th style="padding:8px;">受取時間</th>
      <th style="padding:8px;">店舗</th>
      <th style="padding:8px;">商品一覧</th>
      <th style="padding:8px;">備考</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:8px; border-top:1px solid #eee;">${r.reservationId}</td>
      <td style="padding:8px; border-top:1px solid #eee;">${r.name}</td>
      <td style="padding:8px; border-top:1px solid #eee;">${r.phone}</td>
      <td style="padding:8px; border-top:1px solid #eee;">${r.pickupTime}</td>
      <td style="padding:8px; border-top:1px solid #eee;">${r.store}</td>
      <td style="padding:8px; border-top:1px solid #eee;">${JSON.parse(r.items).map(i => `${i.name} ×${i.qty}`).join("<br>")}</td>
      <td style="padding:8px; border-top:1px solid #eee;">${r.memo || ""}</td>
    `;
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  list.appendChild(table);
}

function calcSummary(data) {
  const summary = {};

  data.forEach(r => {
    const items = JSON.parse(r.items);
    items.forEach(i => {
      if (!summary[i.name]) summary[i.name] = 0;
      summary[i.name] += Number(i.qty);
    });
  });

  return summary;
}
  
function renderSummary(summary) {
  const el = document.getElementById("summary");
  el.innerHTML = "";

  Object.keys(summary).forEach(name => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <strong>${name}</strong>：${summary[name]} 個
    `;
    el.appendChild(div);
  });
}  
  
function filterStore(store, btn) {
  Swal.fire({
    title: "更新中…",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  setTimeout(() => {
    document.querySelectorAll(".store-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    let filtered = store === "all"
      ? dashboardData
      : dashboardData.filter(r => r.store === store);

    renderList(filtered);

    const summary = calcSummary(filtered);
    renderSummary(summary);

    const timeSummary = calcTimeSummary(filtered);
    renderTimeSummary(timeSummary);

    Swal.close();
  }, 150);
}

  function calcTimeSummary(data) {
  const summary = {};

  data.forEach(r => {
    const time = r.pickupTime; // "10:00" など
    const items = JSON.parse(r.items);

    if (!summary[time]) summary[time] = {};

    items.forEach(i => {
      if (!summary[time][i.name]) summary[time][i.name] = 0;
      summary[time][i.name] += Number(i.qty);
    });
  });

  return summary;
}

function renderTimeSummary(summary) {
  const el = document.getElementById("time-summary");
  el.innerHTML = "";

  const times = Object.keys(summary).sort();

  times.forEach(time => {
    const block = document.createElement("div");
    block.className = "time-block";

    let html = `<div class="time-title">${time}</div>`;

    const items = summary[time];
    Object.keys(items).forEach(name => {
      html += `<div>${name}：<strong>${items[name]}</strong> 個</div>`;
    });

    block.innerHTML = html;
    el.appendChild(block);
  });
}

loadDashboard();
</script>

</body>
</html>