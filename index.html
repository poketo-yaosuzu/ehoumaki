<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>新規予約</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="./style.css" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  .product { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
  .badge { display:inline-block; background:#ff4d4d; color:#fff; font-size:12px; font-weight:bold; padding:2px 6px; border-radius:12px; margin-left:6px; }
</style>
</head>
<body>
  <div class="card">
    <h2>恵方巻ご予約フォーム</h2>
    <p>ご予約の確認・変更も出来ます。ページ下部からどうぞ</p>
    <form id="form">
      <label>お名前</label>
      <input type="text" id="name" placeholder="例　山田　太郎" required />
      <label>電話番号</label>
      <input type="tel" id="phone" placeholder="例　090-123-4567" required />
      <label>店舗</label>
      <select id="store" required>
        <option value="">選択してください</option>
        <option>ポケット店</option>
        <option>アップティ店</option>
        <option>キララ店</option>
      </select>
      <label>受取時間</label>※11:00~18:00までの30分刻みです
        <select id="pickup" required>
         <option value="">選択してください</option>
         <option>11:00</option>
         <option>11:30</option>
         <option>12:00</option>
         <option>12:30</option>
         <option>13:00</option>
         <option>13:30</option>
         <option>14:00</option>
         <option>14:30</option>
         <option>15:00</option>
         <option>15:30</option>
         <option>16:00</option>
         <option>16:30</option>
         <option>17:00</option>
         <option>17:30</option>
         <option>18:00</option>
        </select>

      <h3>商品選択</h3>
      <div id="productArea"></div>

      <label>備考</label>
      <textarea id="remarks" placeholder="お伝えしたい事があれば記入下さい"></textarea>

      <div class="actions">
        <button type="button" id="calcBtn">合計を計算</button>
        <span id="totalView">合計(税込): ¥0</span>
      </div>

      <button type="submit">予約送信</button>
      
      
      <label>ご予約の確認・変更をされる方は下のボタンからお願いします</label>
      <button id="checkBtn" type="button">予約確認・変更</button>
<div id="checkModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>予約番号を入力してください</h3>
    <input type="text" id="reservationNumber" />
    <button id="checkOk">確認する</button>
    <button id="checkCancel">閉じる</button>
    <div id="checkResult"></div>
  </div>
</div>
    </form>
  </div>
<!-- モーダルのHTML -->
<div id="confirmModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>この内容でよろしいですか？</h3>
    <div id="modalBody"></div>
    <button id="modalOk">送信する</button>
    <button id="modalCancel">修正する</button>
  </div>
</div>
  
<script>
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz3rAw-Zo4YN91USxgcsLRQOrEM-OkOmvSkO7pLlbMQQnPuyAUIK095dR_msPjvKDr6vA/exec";
const LIFF_ID = "2008688976-XABikxct";

document.addEventListener("DOMContentLoaded", async () => {
  await liff.init({ liffId: LIFF_ID });
  await loadProducts();

  document.getElementById("calcBtn").addEventListener("click", () => {
    const products = collectProducts();
    const subtotalEx = products.reduce((s,p)=>s+p.priceEx*p.qty,0);
    const totalWithTax = Math.round(subtotalEx*1.08);
    document.getElementById("totalView").textContent = `合計(税込): ¥${totalWithTax}`;
  });

  document.getElementById("form").addEventListener("submit", (e) => {
    e.preventDefault();
    const products = collectProducts();
    const subtotalEx = products.reduce((s,p)=>s+p.priceEx*p.qty,0);
    const totalWithTax = Math.round(subtotalEx*1.08);

    const payload = {
      name: document.getElementById("name").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      store: document.getElementById("store").value,
      pickup: document.getElementById("pickup").value,
      products,
      remarks: document.getElementById("remarks").value.trim()
    };

    const productList = products.map(p => `${p.name}×${p.qty}`).join(", ");

    document.getElementById("modalBody").innerHTML = `
      <p>お名前: ${payload.name} 様</p>
      <p>電話番号: ${payload.phone}</p>
      <p>店舗: ${payload.store}</p>
      <p>受取時間: ${payload.pickup}</p>
      <p>商品: ${productList}</p>
      <p>備考: ${payload.remarks}</p>
      <p><strong>合計(税込): ¥${totalWithTax}</strong></p>
    `;
    document.getElementById("confirmModal").style.display = "flex";

    window.currentPayload = payload;
    window.currentTotal = totalWithTax;
  });

  // ★★★ 修正版：構文エラー完全解消 ★★★
  document.getElementById("modalOk").addEventListener("click", async () => {
    const payload = window.currentPayload;
    if (!payload) {
      alert("送信データがありません");
      return;
    }

    try {
const response = await fetch(GAS_WEBAPP_URL, {
  method: "POST",
  mode: "cors",
  headers: { "Content-Type":"application/json" },
  body: JSON.stringify({ action:"create", ...payload })
});

const res = await response.json();

      if (!res.ok) {
        alert("予約に失敗しました: " + (res.error || "不明なエラー"));
        document.getElementById("confirmModal").style.display = "none";
        return;
      }

      const q = new URLSearchParams({
        rn: res.reservationNumber,
        name: payload.name,
        phone: payload.phone,
        store: payload.store,
        pickup: payload.pickup,
        total: res.totalWithTax
      });

      location.href = `./confirm.html?${q.toString()}`;

    } catch (e) {
      console.error("送信時エラー:", e);
      alert("サーバーとの通信でエラーが発生しました");
    }
  });

  document.getElementById("modalCancel").addEventListener("click", () => {
    document.getElementById("confirmModal").style.display = "none";
  });
});

// 商品ロード
async function loadProducts() {
  const response = await fetch(GAS_WEBAPP_URL + "?mode=products", {
    method: "GET",
    mode: "cors"
  });

  const res = await response.json();

  if (!res.ok) {
    alert("商品取得に失敗しました");
    return;
  }



  const area = document.getElementById("productArea");
  area.innerHTML = "";

  res.items.forEach(p => {
    if (!p.enabled) return;
    const disabled = p.stock <= 0 ? "disabled" : "";
    const maxAttr = p.stock > 0 ? `max="${p.stock}"` : "";
    const badge = (p.stock > 0 && p.stock <= 3) ? `<span class="badge">残りわずか</span>` : "";

  area.insertAdjacentHTML("beforeend", `
  <div class="product-card">
    <img src="${p.image}" alt="${p.name}" />
    <h3>${p.name}</h3>
    <p>税込: ¥${p.priceIn}</p>
    <p>在庫: ${p.stock} ${badge}</p>

    <div class="qty-box">
      <button class="minus" data-id="${p.id}">-</button>
      <input type="number" id="qty_${p.id}" min="0" value="0" ${maxAttr} ${disabled} />
      <button class="plus" data-id="${p.id}">+</button>
    </div>

    <input type="hidden" id="priceEx_${p.id}" value="${p.priceEx}" />
    <input type="hidden" id="name_${p.id}" value="${p.name}" />
  </div>
  `);
  });
}

function collectProducts() {
  const list = [];
document.querySelectorAll(".plus").forEach(btn => {
  btn.addEventListener("click", () => {
    const id = btn.dataset.id;
    const input = document.getElementById("qty_" + id);
    const max = Number(input.getAttribute("max") || 999);
    const v = Number(input.value || 0);
    if (v < max) input.value = v + 1;
  });
});

document.querySelectorAll(".minus").forEach(btn => {
  btn.addEventListener("click", () => {
    const id = btn.dataset.id;
    const input = document.getElementById("qty_" + id);
    const v = Number(input.value || 0);
    if (v > 0) input.value = v - 1;
  });
});
  return list;
}

// 予約確認モーダル
document.getElementById("checkBtn").addEventListener("click", () => {
  document.getElementById("checkModal").style.display = "block";
});
document.getElementById("checkCancel").addEventListener("click", () => {
  document.getElementById("checkModal").style.display = "none";
});

document.getElementById("checkOk").addEventListener("click", async () => {
  const number = document.getElementById("reservationNumber").value.trim();
  if (!number) {
    alert("予約番号を入力してください");
    return;
  }

try {
  const response = await fetch(
    GAS_WEBAPP_URL + "?mode=search&number=" + encodeURIComponent(number),
    {
      method: "GET",
      mode: "cors"
    }
  );

  const data = await response.json();

    if (!data.ok) {
      document.getElementById("checkResult").innerHTML = "<p>予約が見つかりませんでした。</p>";
      return;
    }

    document.getElementById("checkResult").innerHTML = `
      <p>お名前: ${data.reservation.name}</p>
      <p>商品: ${data.reservation.product}</p>
      <p>数量: ${data.reservation.qty}</p>
      <p>受取時間: ${data.reservation.time}</p>
      <button id="editBtn">修正する</button>
    `;

    document.getElementById("editBtn").addEventListener("click", () => {
      document.getElementById("name").value = data.reservation.name;
      document.getElementById("phone").value = data.reservation.phone;
      document.getElementById("store").value = data.reservation.store;
      document.getElementById("pickup").value = data.reservation.time;

      if (Array.isArray(data.reservation.products)) {
        data.reservation.products.forEach(item => {
          const qtyInput = document.getElementById("qty_" + item.id);
          if (qtyInput) qtyInput.value = item.qty;
        });
      }

      document.getElementById("remarks").value = data.reservation.remarks || "";
      document.getElementById("checkModal").style.display = "none";
    });

  } catch (err) {
    console.error(err);
    alert("通信エラーが発生しました");
  }
});
</script>
</body>
</html>