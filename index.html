<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æµæ–¹å·»ã”äºˆç´„ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      font-family: "Noto Sans JP", sans-serif;
      background: #f1f3f4;
      margin: 0;
      padding: 20px;
    }
    .wrap {
      max-width: 540px;
      margin: 0 auto;
    }
    .btn {
      display: block;
      padding: 16px;
      margin: 14px 0;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      text-decoration: none;
      color: #fff;
      cursor: pointer;
    }
    .new { background: #06c755; }
    .check { background: #1e88e5; }
     :root{
      --line-green:#06c755;
      --bg:#f1f3f4;
      --card:#ffffff;
      --muted:#8a8f93;
      --accent:#e9f7ee;
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      font-family:"Helvetica","Noto Sans JP",sans-serif;
      background:var(--bg);
      margin:0;
      padding:16px;
    }
    .wrap{max-width:540px;margin:0 auto;}

    /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .btn{
      display:block;
      padding:16px;
      margin:14px 0;
      border-radius:12px;
      font-size:18px;
      font-weight:700;
      text-align:center;
      text-decoration:none;
      color:#fff;
      cursor:pointer;
    }
    .new{background:#06c755;}
    .check{background:#1e88e5;}

    /* äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆã‚ãªãŸã®CSSãã®ã¾ã¾ï¼‰ */
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
    .logo{width:90px;height:44px;border-radius:10px;background:var(--line-green);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px;}
    label.small{display:block;color:var(--muted);font-size:13px;margin-bottom:8px}
    input, textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid #e3e6e8;font-size:15px;background:#fff;}

    /* æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã‚®ãƒ£ãƒ©ãƒªãƒ¼ */
    .gallery{
      display:flex;
      gap:12px;
      overflow-x:auto;
      padding-bottom:10px;
      scroll-snap-type:x mandatory;
    }
    .gallery::-webkit-scrollbar{display:none;}

    .product-card{
      flex:0 0 240px;
      background:#fff;
      border-radius:12px;
      border:1px solid #eef2f1;
      overflow:hidden;
      cursor:pointer;
      scroll-snap-align:start;
      transition:0.12s;
    }
    .product-card:hover{
      transform:translateY(-4px);
      box-shadow:0 10px 22px rgba(0,0,0,0.06)
    }

    .product-media{height:140px;overflow:hidden}
    .product-media img{width:100%;height:100%;object-fit:cover}

    .product-body{padding:10px;display:flex;gap:10px;}
    .product-info{flex:1}
    .product-title{font-weight:700;margin:0 0 6px;}
    .product-desc{margin:0;color:var(--muted);font-size:13px;}
    .badge{
      background:var(--accent);
      color:#0c6b32;
      font-weight:700;
      font-size:12px;
      padding:4px 6px;
      border-radius:999px;
      display:inline-block;
      margin-top:6px
    }

    .qty-wrap{display:flex;align-items:center;gap:6px;margin-top:6px}
    .qty-input{width:56px;text-align:center;border-radius:8px;border:1px solid #e0e0e0}
    .qty-btn{padding:8px 14px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}

    /* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
    .indicator{text-align:center;margin:6px 0 14px;}
    .indicator span{
      display:inline-block;
      width:8px;height:8px;
      margin:0 4px;
      background:#ccc;
      border-radius:50%;
    }
    .indicator .active{background:#06c755;}

    .category-title{
      font-weight:700;
      margin:12px 0 6px;
      font-size:15px;
    }
    
    .product-stock {
  font-size: 12px;
  color: #555;
  margin-top: 4px;
}

    .cart{margin-top:12px;background:#fff;border-radius:12px;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid #eee}
    .cart-item:last-child{border-bottom:none}
    .cart-remove{color:var(--danger);cursor:pointer;font-size:14px}
    .summary{margin-top:8px}
    .summary-row{display:flex;justify-content:space-between;align-items:center}
    .total{font-size:20px;font-weight:800}
    .submit-btn{background:var(--line-green);color:#fff;padding:12px;border-radius:10px;border:none;width:100%;font-size:16px;cursor:pointer;margin-top:10px}
    footer{text-align:center;color:var(--muted);font-size:13px;margin-top:12px;}
  </style>
</head>

<body>
<div class="wrap">

  <!-- ========================= -->
  <!-- â‘  ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
  <!-- ========================= -->
  <div id="screen-menu">
    <h1>æµæ–¹å·»ã”äºˆç´„ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>

    <div class="btn new" onclick="openReservation()">
      ğŸŸ© æ–°è¦äºˆç´„ã‚’ã™ã‚‹
    </div>

<div class="btn check" onclick="showScreen('screen-search')">
  ğŸŸ¦ äºˆç´„ã®ç¢ºèªãƒ»å¤‰æ›´ã‚’ã™ã‚‹
</div>
  </div>

  <!-- ========================= -->
  <!-- â‘¡ æ–°è¦äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ         -->
  <!-- ========================= -->
 <div id="screen-reservation" style="display:none;">

    <header>
      <div class="logo">YAOSUZU</div>
      <div>
        <h1>æµæ–¹å·»ã”äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </h1>
        <div style="font-size:13px;color:#666">å—å–æ—¥ã¯<strong>2æœˆ3æ—¥(ç«)é™å®š</strong>ã§ã™</div>
      </div>
    </header>

    <form id="reservationForm" class="card" autocomplete="off">

      <div style="display:flex; gap:8px; margin-bottom:10px">
        <input type="text" id="name" placeholder="ãŠåå‰" required>æ§˜
        <input type="tel" id="phone" placeholder="é›»è©±ç•ªå·" required>
      </div>

      <label class="small">å—å–åº—èˆ—ã€€â€»ã“ã®åº—èˆ—ã§ãŠæ”¯æ‰•ã„ã¨ãªã‚Šã¾ã™ã€‚</label>
      <select id="store" required>
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ãƒã‚±ãƒƒãƒˆåº—">ãƒã‚±ãƒƒãƒˆåº—</option>
        <option value="ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—">ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—</option>
        <option value="ã‚­ãƒ©ãƒ©åº—">ã‚­ãƒ©ãƒ©åº—</option>
        <option value="ç·èœå·¥å ´">ç·èœå·¥å ´</option>
      </select>

      <label class="small">å—å–æ™‚é–“ã€€â€»10:00ã€œ18:00ã¾ã§ã®30åˆ†åˆ»ã¿ã§ã™ã€‚</label>
      <select id="pickupTime" required></select>

      <div class="category-title">ã‚»ãƒƒãƒˆå•†å“</div>
      <div class="gallery" id="gallery-set"></div>
      <div class="indicator" id="indicator-set"></div>

      <div class="category-title">å˜å“å•†å“</div>
      <div class="gallery" id="gallery-single"></div>
      <div class="indicator" id="indicator-single"></div>

      <div class="cart" id="cart"></div>

      <div class="summary">
        <div class="summary-row">
          <div>åˆè¨ˆé‡‘é¡ï¼š</div>
          <div class="total"><span id="total">0</span>å††</div>
        </div>
        <div style="font-size:13px;color:#888">â€»ä¾¡æ ¼ã¯ç¨åˆ¥ã§ã™ã€‚åº—èˆ—ä¼šè¨ˆæ™‚ã«åˆ¥é€”æ¶ˆè²»ç¨ãŒè¶³ã•ã‚Œã¾ã™ã€‚</div>
      </div>

      <label class="small" style="margin-top:12px">å‚™è€ƒ</label>
      <textarea id="memo" placeholder="ãŠä¼ãˆã—ãŸã„ã“ã¨ãŒã‚ã‚Œã°è¨˜å…¥ãã ã•ã„ã€‚" rows="3"></textarea>

      <button type="submit" class="submit-btn">é€ä¿¡ã™ã‚‹</button>
    </form>

    <footer>Â©ï¸ ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¤ã‚ªã‚¹ã‚º</footer>

    <button onclick="showScreen('screen-menu')" style="margin-top:20px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
  </div>
<!-- ========================= -->
<!-- â‘¢ äºˆç´„ç•ªå·å…¥åŠ›ç”»é¢ -->
<!-- ========================= -->
<div id="screen-search" style="display:none;">
  <h2>äºˆç´„ç•ªå·ã§æ¤œç´¢</h2>

  <input id="searchId" type="text" placeholder="äºˆç´„ç•ªå·ã‚’å…¥åŠ›" style="padding:8px; width:200px;">
  <button onclick="searchReservation()">æ¤œç´¢</button>

  <div id="search-result" style="margin-top:20px;"></div>

  <button onclick="showScreen('screen-menu')" style="margin-top:20px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>
  
  <!-- ========================= -->
  <!-- â‘£ äºˆç´„ç·¨é›†ç”»é¢ -->
  <!-- ========================= -->
  <div id="screen-edit" style="display:none;">
    <h2>äºˆç´„å†…å®¹ã®å¤‰æ›´</h2>
    <div id="edit-area"></div>
    <button onclick="showScreen('screen-mypage')">ä¸€è¦§ã«æˆ»ã‚‹</button>
  </div>
  
</div>


  <!-- ========================= -->
  <!-- å•ã„åˆã‚ã›ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã€€ã€€ã€€ -->
  <!-- ========================= --> 
  <div id="loadingModal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  z-index:9999;
  align-items:center;
  justify-content:center;
  font-size:20px;
  color:#fff;
">
  å•ã„åˆã‚ã›ä¸­ã§ã™â€¦
</div>
  
<script>
/* =========================
   è¨­å®š
========================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycby7WWViNlCVrzsl0ALI4rB-hZncgtgyFmbNW8IB66mZusBlJ4ntppprcCd9-HdHGEfcKw/exec";
const LIFF_ID = "2008688976-XABikxct";
const fixedPickupDate = "2026-02-03";ã€€//ã“ã“ã«ç¯€åˆ†ã®æ—¥ä»˜ã‚’å…¥ã‚Œã‚‹

const USE_TEST_ID =false; //ã™ã‚‹ã€€true ã—ãªã„ã€€false
const TEST_USER_ID = "U**********";
let userId = "";

/* =========================
   å•†å“ãƒ‡ãƒ¼ã‚¿ï¼ˆå¾Œã§ GAS é€£æºã«å·®ã—æ›¿ãˆå¯èƒ½ï¼‰
========================= */
let PRODUCTS = [];

async function loadProducts() {
  try {
    const res = await fetch(`${GAS_URL}?mode=products`);
    const json = await res.json();

    if (json.result === "success") {
      PRODUCTS = json.products;
    } else {
      Swal.fire({ icon: "error", title: "å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼" });
    }
  } catch (e) {
    Swal.fire({ icon: "error", title: "é€šä¿¡ã‚¨ãƒ©ãƒ¼", text: e.message });
  }
}

/* =========================
   ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
========================= */
function showScreen(id) {
  document.querySelectorAll("[id^='screen-']").forEach(el => el.style.display = "none");
  document.getElementById(id).style.display = "block";
}

/* =========================
   æ–°è¦äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
========================= */
async function openReservation() {
  showScreen("screen-reservation");
  await loadProducts();   // â† å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  initReservationForm();  // â† ã‚®ãƒ£ãƒ©ãƒªãƒ¼æç”»ãªã©
}

/* =========================
   å—å–æ™‚é–“ç”Ÿæˆ
========================= */
function renderPickupTimes(){
  const el = document.getElementById("pickupTime");
  el.innerHTML = "";
  for(let h=10; h<=18; h++){
    for(const m of ["00","30"]){
      if(h===18 && m==="30") continue;
      const val = `${String(h).padStart(2,"0")}:${m}`;
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      el.appendChild(opt);
    }
  }
}

/* =========================
   æ—©å‰²åˆ¤å®š
========================= */
function isEarlyActive(until){
  if(!until) return false;
  const today = new Date();
  const d = new Date(until + "T23:59:59");
  return today <= d;
}

/* =========================
   å•†å“ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
========================= */
function createProductCard(p){
  const card = document.createElement("div");
  card.className = "product-card";

  // ã‚«ãƒ¼ãƒ‰æœ¬ä½“ï¼ˆä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã‚‹éƒ¨åˆ†ï¼‰
  card.innerHTML = `
      <div class="product-stock">åœ¨åº«æ•°æ®‹ã‚Šï¼š${p.stock}</div>
  `;

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  card.onclick = () => {
    Swal.fire({
      title: `${p.name}ã€€${p.price.toLocaleString()}å††`,
      html: `
        <img src="${p.img}" style="width:100%;border-radius:10px;margin-bottom:10px">
        <div style="text-align:left;font-size:14px;color:#444">
          <strong>èª¬æ˜ï¼š</strong><br>${p.desc}<br><br>
          <strong>å…·æï¼š</strong>
          <ul style="padding-left:20px;margin-top:6px">
            ${p.ingredients.map(i => `<li>${i}</li>`).join("")}
          </ul>
        </div>
      `,
      showCloseButton: true,
      confirmButtonText: "é–‰ã˜ã‚‹"
    });
  };

  /* ãƒ¡ãƒ‡ã‚£ã‚¢ */
  const media = document.createElement("div");
  media.className = "product-media";
  const img = document.createElement("img");
  img.src = p.img;
  media.appendChild(img);

  /* æœ¬æ–‡ */
  const body = document.createElement("div");
  body.className = "product-body";

  const info = document.createElement("div");
  info.className = "product-info";

  const title = document.createElement("div");
  title.className = "product-title";
  title.textContent = `${p.name} ${p.price.toLocaleString()}å††`;

  const desc = document.createElement("p");
  desc.className = "product-desc";
  desc.textContent = p.desc;

  info.appendChild(title);
  info.appendChild(desc);

  /* æ—©å‰²ãƒãƒƒã‚¸ */
  if(isEarlyActive(p.discountUntil)){
    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = `${p.discountUntil} ã¾ã§ ${Math.round(p.earlyDiscount*100)}%OFF`;
    info.appendChild(badge);
  }

  /* åœ¨åº«ãƒãƒƒã‚¸ */
  if (p.stock <= 0) {
    const soldOut = document.createElement("div");
    soldOut.className = "badge";
    soldOut.style.background = "#ccc";
    soldOut.style.color = "#333";
    soldOut.textContent = "æ•°é‡ã«é”ã—ãŸç‚ºã€çµ‚äº†ã—ã¾ã—ãŸ";
    info.appendChild(soldOut);
  } else if (p.stock <= 20) {
    const low = document.createElement("div");
    low.className = "badge";
    low.style.background = "#ffe9c4";
    low.style.color = "#b45f00";
    low.textContent = "æ®‹ã‚Šã‚ãšã‹ï¼";
    info.appendChild(low);
  }

  /* æ•°é‡ï¼‹è¿½åŠ ãƒœã‚¿ãƒ³ */
  const qtyWrap = document.createElement("div");
  qtyWrap.className = "qty-wrap";

  const qty = document.createElement("input");
  qty.type = "number";
  qty.value = 1;
  qty.min = 1;
  qty.max = p.stock;
  qty.className = "qty-input";

  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.textContent = "è¿½åŠ ";
  addBtn.className = "qty-btn";

  /* å£²ã‚Šåˆ‡ã‚Œå‡¦ç† */
  if (p.stock <= 0) {
    qty.disabled = true;
    addBtn.disabled = true;
    addBtn.textContent = "å£²ã‚Šåˆ‡ã‚Œ";
    addBtn.style.background = "#ccc";
    addBtn.style.cursor = "not-allowed";
  }

  addBtn.onclick = (e) => {
    e.stopPropagation();

    const requested = Number(qty.value);
    if (requested > p.stock) {
      Swal.fire({
        icon: "warning",
        title: "åœ¨åº«ä¸è¶³",
        text: `åœ¨åº«ã¯æ®‹ã‚Š ${p.stock} å€‹ã§ã™`
      });
      qty.value = p.stock;
      return;
    }

    const isActive = isEarlyActive(p.discountUntil);
    const appliedPrice = isActive ? Math.floor(p.price*(1-p.earlyDiscount)) : p.price;

    addToCart(p.name, requested, appliedPrice);
    qty.value = 1;
  };

  qtyWrap.appendChild(qty);
  qtyWrap.appendChild(addBtn);

  body.appendChild(info);
  body.appendChild(qtyWrap);

  card.appendChild(media);
  card.appendChild(body);

  return card;
}
  
function openEdit(reservationId) {
  showScreen("screen-edit");
  loadEditForm(reservationId); // â† PART 4 ã§å®Ÿè£…ã™ã‚‹
}
  
/* =========================
   ã‚®ãƒ£ãƒ©ãƒªãƒ¼æç”»
========================= */
function renderGallery(){
  const gSet = document.getElementById("gallery-set");
  const gSingle = document.getElementById("gallery-single");

  gSet.innerHTML = "";
  gSingle.innerHTML = "";

  PRODUCTS.forEach(p => {
    const card = createProductCard(p);
    if(p.category === "set") gSet.appendChild(card);
    else gSingle.appendChild(card);
  });

  setupIndicator(gSet, document.getElementById("indicator-set"));
  setupIndicator(gSingle, document.getElementById("indicator-single"));
}

/* =========================
   ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿
========================= */
function setupIndicator(galleryEl, indicatorEl){
  const cards = galleryEl.querySelectorAll(".product-card");
  indicatorEl.innerHTML = "";

  cards.forEach((_, i) => {
    const dot = document.createElement("span");
    if(i === 0) dot.classList.add("active");
    indicatorEl.appendChild(dot);
  });

  galleryEl.addEventListener("scroll", () => {
    const scrollLeft = galleryEl.scrollLeft;
    const cardWidth = galleryEl.querySelector(".product-card").offsetWidth + 12;
    const index = Math.round(scrollLeft / cardWidth);

    indicatorEl.querySelectorAll("span").forEach((d, i) => {
      d.classList.toggle("active", i === index);
    });
  });
}

/* =========================
   ã‚«ãƒ¼ãƒˆå‡¦ç†
========================= */
let cart = [];

function addToCart(name, qty, price){
  qty = Number(qty);
  const i = cart.findIndex(c=>c.name===name);
  if(i>=0) cart[i].qty += qty;
  else cart.push({name, qty, price});
  renderCart();
}

function renderCart(){
  const el=document.getElementById("cart");
  el.innerHTML="";
  cart.forEach(c=>{
    const item=document.createElement("div");
    item.className="cart-item";
    item.innerHTML=`${c.name} Ã—${c.qty} <span class='cart-remove' data-name='${c.name}'>å‰Šé™¤</span> <span>${c.price.toLocaleString()}å††</span>`;
    el.appendChild(item);
  });
  document.querySelectorAll(".cart-remove").forEach(b=>b.onclick=()=>removeFromCart(b.dataset.name));
  updateTotal();
}

function removeFromCart(name){
  cart = cart.filter(c=>c.name!==name);
  renderCart();
}

function updateTotal(){
  const sum = cart.reduce((s,c)=>s+c.price*c.qty,0);
  document.getElementById("total").textContent=sum.toLocaleString();
}

/* =========================
   LIFF åˆæœŸåŒ–
========================= */
(async()=>{
  if(USE_TEST_ID){
    userId = TEST_USER_ID;
    return;
  }
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()) return liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
  }catch(e){
    Swal.fire({ icon:"error", title:"LINEãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ" });
  }
})();

/* =========================
   é€ä¿¡å‡¦ç†ï¼ˆä»¥å‰ã®æ–¹å¼ãƒ»å®Œå…¨ç‰ˆï¼‰
========================= */

// â˜… form ã‚’æ­£ã—ãå–å¾—
const form = document.getElementById("reservationForm");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!userId) {
    return Swal.fire({ icon: "warning", title: "LINEãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒç¢ºèªã§ãã¾ã›ã‚“" });
  }
  if (cart.length === 0) {
    return Swal.fire({ icon: "warning", title: "å•†å“ã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„" });
  }

  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const store = document.getElementById("store").value;
  const pickupTime = document.getElementById("pickupTime").value;
  const memo = document.getElementById("memo").value || "";

  if (!name || !phone || !store || !pickupTime) {
    return Swal.fire({ icon: "warning", title: "å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" });
  }

  const phonePattern = /^0\d{9,10}$/;
  if (!phonePattern.test(phone.replace(/-/g, ""))) {
    return Swal.fire({ icon: "warning", title: "é›»è©±ç•ªå·ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“" });
  }

  const productsText = cart
    .map(c => `${c.name} Ã—${c.qty}ï¼ˆå˜ä¾¡ ${c.price.toLocaleString()}å††ï¼‰`)
    .join("\n");

  const total = cart.reduce((sum, c) => sum + c.price * c.qty, 0);

  // â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒç¢ºå®Ÿã«å‡ºã‚‹ã‚ˆã†ã«ä¿®æ­£
  const confirmResult = await Swal.fire({
    icon: "question",
    title: "å†…å®¹ç¢ºèª",
    html: `
      <div style="text-align:left; white-space:pre-wrap; font-size:16px;">
        ${productsText}
        <br><br>
        <strong>åˆè¨ˆ: ${total.toLocaleString()}å††</strong>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: "é€ä¿¡",
    cancelButtonText: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
  });

  if (!confirmResult.isConfirmed) return;

  try {
    Swal.fire({
      title: "é€ä¿¡ä¸­...",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });
console.log("é€ä¿¡ã™ã‚‹ userId:", userId);
const payload = {
  mode: "new",   // â† ã“ã‚ŒãŒå¿…é ˆï¼
  name,
  phone,
  store,
  pickupDate: fixedPickupDate,
  pickupTime,
  total,
  memo,
  userId,
  items: cart
};

    const params = new URLSearchParams();
    params.set("payload", JSON.stringify(payload));

    const res = await fetch(GAS_URL, {
      method: "POST",
      body: params
    });

    const json = await res.json();
    Swal.close();

    if (json.result === "success") {
      Swal.fire({
        icon: "success",
        title: "äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼",
        text: `äºˆç´„ç•ªå·ï¼š${json.reservationId}`
      });

      cart = [];
      renderCart();
      form.reset();
      showScreen("screen-menu");

    } else {
      Swal.fire({ icon: "error", title: "ã‚¨ãƒ©ãƒ¼", text: json.message || "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼" });
    }

  } catch (err) {
    Swal.close();
    Swal.fire({ icon: "error", title: "é€šä¿¡ã‚¨ãƒ©ãƒ¼", text: err.message });
  }
});

  /* =========================
   åˆæœŸæç”»ï¼ˆç”»é¢ã‚’é–‹ã„ãŸæ™‚ã ã‘ï¼‰
========================= */
function initReservationForm() {
  renderPickupTimes();
  renderGallery();
  updateTotal();
}
  
  /* =========================
   äºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
========================= */
async function loadReservations() {
  if (!userId) {
    Swal.fire({ icon: "warning", title: "LINEãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒç¢ºèªã§ãã¾ã›ã‚“" });
    return;
  }

  showScreen("screen-mypage");

  const list = document.getElementById("reservation-list");
  list.innerHTML = "èª­ã¿è¾¼ã¿ä¸­â€¦";

  try {
    const res = await fetch(`${GAS_URL}?mode=reservations&userId=${userId}`);
    const json = await res.json();

    if (json.result !== "success") {
      list.innerHTML = "äºˆç´„æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
      return;
    }

    const reservations = json.reservations;

    if (reservations.length === 0) {
      list.innerHTML = "<p>äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      return;
    }

    list.innerHTML = "";

    reservations.forEach(r => {
      const div = document.createElement("div");
      div.className = "card";
      div.style.marginBottom = "12px";

      div.innerHTML = `
        <div style="font-weight:700;font-size:16px;">äºˆç´„ç•ªå·ï¼š${r.reservationId}</div>
        <div style="margin-top:6px;">å—å–æ—¥æ™‚ï¼š${r.pickupDate} ${r.pickupTime}</div>
        <div style="margin-top:6px;">åº—èˆ—ï¼š${r.store}</div>
        <button class="submit-btn" style="margin-top:10px;" onclick="openEdit('${r.reservationId}')">
          å¤‰æ›´ã™ã‚‹
        </button>
      `;

      list.appendChild(div);
    });

  } catch (err) {
    list.innerHTML = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  }
}
  
   /* =========================
   äºˆç´„ç•ªå·å•ã„åˆã‚ã›
========================= */
async function searchReservation() {
  const input = document.getElementById("searchId");

  if (!input) {
    console.log("searchId ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  const id = input.value.trim();
  console.log("å–å¾—ã—ãŸID:", id);

  if (!id) {
    alert("äºˆç´„ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  // â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  document.getElementById("loadingModal").style.display = "flex";

  try {
    const res = await fetch(`${GAS_URL}?mode=getReservation&id=${id}`);
    const json = await res.json();

    const area = document.getElementById("search-result");

    if (json.result !== "success") {
      area.innerHTML = `<div style="color:red;">äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
    } else {
      const r = json.reservation;
      area.innerHTML = `
        <div class="card">
          <p><b>äºˆç´„ç•ªå·ï¼š</b>${r["äºˆç´„ç•ªå·"]}</p>
          <p><b>åå‰ï¼š</b>${r["åå‰"]}</p>
          <p><b>é›»è©±ç•ªå·ï¼š</b>${r["é›»è©±ç•ªå·"]}</p>
          <p><b>å—å–åº—èˆ—ï¼š</b>${r["åº—èˆ—"]}</p>
          <p><b>å—å–æ™‚é–“ï¼š</b>${r["å—å–æ™‚é–“"]}</p>
          <p><b>å•†å“ä¸€è¦§ï¼š</b><br>${JSON.parse(r["å•†å“ä¸€è¦§"]).map(i => `${i.name} Ã—${i.qty}`).join("<br>")}</p>
          <p><b>å‚™è€ƒï¼š</b>${r["å‚™è€ƒ"] || ""}</p>
          <button onclick="openEdit('${r["äºˆç´„ç•ªå·"]}')">ã“ã®äºˆç´„ã‚’ä¿®æ­£ã™ã‚‹</button>
        </div>
      `;
    }
  } catch (e) {
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
  } finally {
    // â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
    document.getElementById("loadingModal").style.display = "none";
  }
}
  
/**
 * openEdit â†’ loadEditForm ã« id ã‚’æ¸¡ã™
 *                                ***/
  
  function openEdit(id) {
  showScreen("screen-edit");
  loadEditForm(id);
}


  /* =========================
   äºˆç´„ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚€
========================= */
async function loadEditForm(id) {
  const area = document.getElementById("edit-area");
  area.innerHTML = "èª­ã¿è¾¼ã¿ä¸­â€¦";

  try {
    const res = await fetch(`${GAS_URL}?mode=getReservation&id=${id}`);
    const json = await res.json();

    if (json.result !== "success") {
      area.innerHTML = "äºˆç´„æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
      return;
    }

    const r = json.reservation;

    editCart = JSON.parse(r["å•†å“ä¸€è¦§"]);

    area.innerHTML = `
      <div class="card">
        <div style="font-weight:700;font-size:16px;">äºˆç´„ç•ªå·ï¼š${r["äºˆç´„ç•ªå·"]}</div>
        <div style="margin-top:6px;">å—å–æ—¥æ™‚ï¼š${r["å—å–æ—¥"]} ${r["å—å–æ™‚é–“"]}</div>
        <div style="margin-top:6px;">åº—èˆ—ï¼š${r["åº—èˆ—"]}</div>
      </div>

      <h3>å•†å“ã‚’å¤‰æ›´</h3>
      <div id="edit-cart"></div>

      <h3>å•†å“ã‚’è¿½åŠ </h3>
      <div class="gallery" id="edit-gallery"></div>

      <button class="submit-btn" onclick="submitEdit('${r["äºˆç´„ç•ªå·"]}')">
        å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹
      </button>
    `;

    renderEditCart();
    renderEditGallery();

  } catch (err) {
    area.innerHTML = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  }
}
  
  /* =========================
   ç·¨é›†ç”¨ã‚«ãƒ¼ãƒˆ
========================= */
let editCart = [];

function renderEditCart() {
  const el = document.getElementById("edit-cart");
  el.innerHTML = "";

  editCart.forEach(c => {
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      ${c.name} Ã—${c.qty}
      <span class="cart-remove" onclick="removeEditItem('${c.name}')">å‰Šé™¤</span>
    `;
    el.appendChild(div);
  });
}

function removeEditItem(name) {
  editCart = editCart.filter(c => c.name !== name);
  renderEditCart();
}
  
  /* =========================
   ç·¨é›†ç”»é¢ã®å•†å“ã‚®ãƒ£ãƒ©ãƒªãƒ¼
========================= */
function renderEditGallery() {
  const g = document.getElementById("edit-gallery");
  g.innerHTML = "";

  PRODUCTS.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";

    card.innerHTML = `
      <div class="product-media">
        <img src="${p.img}">
      </div>
      <div class="product-body">
        <div class="product-info">
          <div class="product-title">${p.name} ${p.price.toLocaleString()}å††</div>
          <div class="product-desc">${p.desc}</div>
        </div>
        <button class="qty-btn" onclick="addEditItem('${p.name}', ${p.price})">è¿½åŠ </button>
        <div class="stock">åœ¨åº«ï¼š${p.stock}</div>
      </div>
    `;

    g.appendChild(card);
  });
}

function addEditItem(name, price) {
  const i = editCart.findIndex(c => c.name === name);
  if (i >= 0) editCart[i].qty++;
  else editCart.push({ name, qty: 1, price });

  renderEditCart();
}
  
  /* =========================
   äºˆç´„å¤‰æ›´ã‚’é€ä¿¡
========================= */
async function submitEdit(reservationId) {
  if (editCart.length === 0) {
    Swal.fire({ icon: "warning", title: "å•†å“ã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„" });
    return;
  }

  const total = editCart.reduce((s, c) => s + c.price * c.qty, 0);

  const confirmResult = await Swal.fire({
    icon: "question",
    title: "å¤‰æ›´å†…å®¹ã‚’ç¢ºèª",
    html: editCart.map(c => `${c.name} Ã—${c.qty}`).join("<br>") +
          `<br><br>åˆè¨ˆï¼š${total.toLocaleString()}å††`,
    showCancelButton: true,
    confirmButtonText: "å¤‰æ›´ã™ã‚‹",
    cancelButtonText: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
  });

  if (!confirmResult.isConfirmed) return;

  const formData = new URLSearchParams({
    mode: "update",
    reservationId,
    items: JSON.stringify(editCart),
    total
  });

  try {
    Swal.fire({
      title: "å¤‰æ›´ã‚’ä¿å­˜ä¸­â€¦",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    const res = await fetch(GAS_URL, {
      method: "POST",
      body: formData
    });

    const json = await res.json();
    Swal.close();

    if (json.result === "success") {
      Swal.fire({
        icon: "success",
        title: "å¤‰æ›´ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
      });

      showScreen("screen-mypage");
      loadReservations();

    } else {
      Swal.fire({
        icon: "error",
        title: "ã‚¨ãƒ©ãƒ¼",
        text: json.message || "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼"
      });
    }

  } catch (err) {
    Swal.close();
    Swal.fire({ icon: "error", title: "é€šä¿¡ã‚¨ãƒ©ãƒ¼", text: err.message });
  }
}
</script>

</body>
</html>